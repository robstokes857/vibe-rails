<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeRails Terminal Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #569cd6;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #808080;
            margin-bottom: 30px;
        }
        .session-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #252526;
            border-radius: 4px;
            border-left: 3px solid #569cd6;
        }
        .session-info h3 {
            margin: 0 0 10px 0;
            color: #569cd6;
        }
        .session-id {
            font-family: 'Cascadia Code', 'Cascadia Mono', Consolas, monospace;
            color: #4ec9b0;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #0e639c;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #1177bb;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #34ce57;
        }
        .btn-danger {
            background: #d73a49;
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background: #f44747;
        }
        .status {
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-connected {
            background: rgba(78, 201, 176, 0.2);
            color: #4ec9b0;
            border: 1px solid #4ec9b0;
        }
        .status-disconnected {
            background: rgba(212, 212, 212, 0.1);
            color: #808080;
            border: 1px solid #808080;
        }
        .status-error {
            background: rgba(247, 71, 71, 0.2);
            color: #f44747;
            border: 1px solid #f44747;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        .terminal-container {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #3e3e42;
        }
        #terminal {
            /* Let terminal size itself based on rows/cols */
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #808080;
        }
        .instructions {
            margin-top: 30px;
            padding: 15px;
            background: #252526;
            border-radius: 4px;
            border-left: 3px solid #dcdcaa;
        }
        .instructions h3 {
            margin: 0 0 10px 0;
            color: #dcdcaa;
        }
        .instructions ol {
            margin: 0;
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è VibeRails Terminal Viewer</h1>
        <p class="subtitle">Connect to and control active terminal sessions</p>

        <div id="session-info" class="session-info" style="display: none;">
            <h3>Active Session</h3>
            <div>Session ID: <span id="session-id" class="session-id"></span></div>
        </div>

        <div id="no-session" class="session-info" style="display: none;">
            <h3>No Active Session</h3>
            <p style="margin: 0;">No terminal session is currently running. Start one in the main VibeRails UI first.</p>
        </div>

        <div class="controls">
            <label for="port-input" style="font-weight: 600;">Port:</label>
            <input type="number" id="port-input" value="5000" placeholder="5000-5999" min="5000" max="5999"
                   style="width: 100px; padding: 10px; border: 1px solid #3e3e42; border-radius: 4px; background: #2d2d30; color: #d4d4d4; font-weight: 600; font-size: 14px;">
            <button id="refresh-btn" class="btn-primary" disabled>üîÑ Check Session</button>
            <button id="connect-btn" class="btn-success" disabled>‚ñ∂Ô∏è Connect</button>
            <button id="disconnect-btn" class="btn-danger" disabled>‚èπÔ∏è Disconnect</button>
        </div>

        <div id="status" class="status status-disconnected">
            <div class="status-indicator"></div>
            <span>Enter port number and check session</span>
        </div>

        <div class="terminal-container">
            <div id="terminal"></div>
        </div>

        <div class="instructions">
            <h3>üí° How to Use</h3>
            <ol>
                <li>Start a terminal session in the main VibeRails web UI (default: <code>http://localhost:5123</code>)</li>
                <li>If using a different port (5000-5999), enter it in the Port field above</li>
                <li>Click "Check Session" to discover the active session</li>
                <li>Click "Connect" to take over the terminal session</li>
                <li>Type commands directly in this terminal - you have full control!</li>
                <li>If another viewer connects, you'll see "[Session taken over]" and be disconnected</li>
            </ol>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script>
        // Helper functions
        function getPort() {
            return document.getElementById('port-input').value;
        }

        function getApiBase() {
            return `http://localhost:${getPort()}`;
        }

        function getWsUrl() {
            return `ws://localhost:${getPort()}/api/v1/terminal/ws`;
        }

        // State
        let terminal = null;
        let fitAddon = null;
        let socket = null;
        let activeSessionId = null;

        // DOM Elements
        const sessionInfoEl = document.getElementById('session-info');
        const noSessionEl = document.getElementById('no-session');
        const sessionIdEl = document.getElementById('session-id');
        const portInput = document.getElementById('port-input');
        const refreshBtn = document.getElementById('refresh-btn');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const statusEl = document.getElementById('status');
        const terminalEl = document.getElementById('terminal');

        // Validate port input
        function validatePort() {
            const port = portInput.value;
            if (port && port >= 5000 && port <= 5999) {
                refreshBtn.disabled = false;
                return true;
            } else {
                refreshBtn.disabled = true;
                connectBtn.disabled = true;
                return false;
            }
        }

        // Enable check button when port is entered
        portInput.addEventListener('input', validatePort);

        // Allow Enter key to trigger check session
        portInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && validatePort()) {
                refreshBtn.click();
            }
        });

        // Initialize terminal
        function initTerminal() {
            if (terminal) {
                terminal.dispose();
            }

            terminal = new Terminal({
                cols: 120,
                rows: 30,
                cursorBlink: false,
                fontFamily: '"Cascadia Code", "Cascadia Mono", Consolas, "DejaVu Sans Mono", monospace',
                fontSize: 14,
                allowProposedApi: true,
                unicodeVersion: '11',
                disableStdin: false,
                convertEol: false,
                cursorStyle: 'block',
                theme: {
                    background: '#1e1e1e',
                    foreground: '#d4d4d4',
                    cursor: '#d4d4d4',
                    cursorAccent: '#1e1e1e',
                    selection: '#264f78',
                    black: '#1e1e1e',
                    red: '#f44747',
                    green: '#608b4e',
                    yellow: '#dcdcaa',
                    blue: '#569cd6',
                    magenta: '#c586c0',
                    cyan: '#4ec9b0',
                    white: '#d4d4d4',
                    brightBlack: '#808080',
                    brightRed: '#f44747',
                    brightGreen: '#608b4e',
                    brightYellow: '#dcdcaa',
                    brightBlue: '#569cd6',
                    brightMagenta: '#c586c0',
                    brightCyan: '#4ec9b0',
                    brightWhite: '#ffffff'
                }
            });

            fitAddon = new FitAddon.FitAddon();
            terminal.loadAddon(fitAddon);
            terminal.open(terminalEl);
            fitAddon.fit();

            // Handle window resize
            window.addEventListener('resize', () => {
                if (fitAddon) {
                    fitAddon.fit();
                }
            });

            // Send input to WebSocket
            terminal.onData((data) => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(data);
                }
            });
        }

        // Check for active session
        async function checkSession() {
            if (!validatePort()) return;

            try {
                updateStatus('Checking...', 'disconnected');
                const response = await fetch(`${getApiBase()}/api/v1/terminal/status`);
                const data = await response.json();

                if (data.hasActiveSession) {
                    activeSessionId = data.sessionId;
                    sessionIdEl.textContent = activeSessionId;
                    sessionInfoEl.style.display = 'block';
                    noSessionEl.style.display = 'none';
                    connectBtn.disabled = false;
                    updateStatus('Ready to connect', 'disconnected');
                } else {
                    activeSessionId = null;
                    sessionInfoEl.style.display = 'none';
                    noSessionEl.style.display = 'block';
                    connectBtn.disabled = true;
                    updateStatus('No active session', 'disconnected');
                }
            } catch (error) {
                console.error('Failed to check session:', error);
                updateStatus(`Error: ${error.message}`, 'error');
                sessionInfoEl.style.display = 'none';
                noSessionEl.style.display = 'none';
                connectBtn.disabled = true;
            }
        }

        // Connect to WebSocket
        function connectToSession() {
            if (!activeSessionId) {
                updateStatus('No session to connect to', 'error');
                return;
            }

            // Reset terminal state before receiving replay data
            if (terminal) {
                terminal.reset();
            }

            updateStatus('Connecting...', 'disconnected');

            socket = new WebSocket(getWsUrl());
            socket.binaryType = 'arraybuffer';

            socket.onopen = () => {
                updateStatus('Connected', 'connected');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;

                // Backend will replay buffered output to rebuild screen state
                // No need to send Ctrl+L anymore

                terminal.focus();
            };

            socket.onmessage = (event) => {
                terminal.write(new Uint8Array(event.data));
            };

            socket.onclose = (event) => {
                const reason = event.reason || 'Connection closed';
                const message = reason.includes('taken over') ? 'Session taken over by another viewer' : `Disconnected: ${reason}`;
                updateStatus(message, 'disconnected');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                socket = null;

                // Show takeover message in terminal if applicable
                if (reason.includes('taken over')) {
                    terminal.writeln('\r\n\x1b[33m[Session taken over by another viewer]\x1b[0m\r\n');
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Connection error', 'error');
            };
        }

        // Disconnect from session
        function disconnectFromSession() {
            if (socket) {
                socket.close();
                socket = null;
            }
            updateStatus('Disconnected', 'disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
        }

        // Update status UI
        function updateStatus(text, state) {
            statusEl.className = `status status-${state}`;
            statusEl.querySelector('span').textContent = text;
        }

        // Event handlers
        refreshBtn.addEventListener('click', checkSession);
        connectBtn.addEventListener('click', connectToSession);
        disconnectBtn.addEventListener('click', disconnectFromSession);

        // Initialize
        initTerminal();
        validatePort(); // Check initial state
    </script>
</body>
</html>
